FROM ubuntu:16.04
MAINTAINER Gigantum <hello@gigantum.io>

# Install system level dependencies
RUN apt-get -y update; apt-get install -y software-properties-common; add-apt-repository ppa:jonathonf/python-3.6
RUN apt-get -y upgrade;
RUN apt-get -y update; apt-get -y install build-essential python3.6-dev libleveldb-dev libleveldb1v5 git supervisor curl gosu redis-server python-dev vim emacs zip

# Install node
RUN curl -sL https://deb.nodesource.com/setup_6.x | bash -
RUN apt-get -y install nodejs

# Install Yarn
RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
RUN echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
RUN apt-get update && apt-get install yarn

# Build Watchman
RUN apt-get -y install gtk-doc-tools libtool m4 autotools-dev autoconf automake libssl-dev libcrypto++-dev
RUN git clone https://github.com/facebook/watchman.git; cd watchman; git checkout v4.8.0; ./autogen.sh; ./configure; make; make install

# Install pip with PPA 3.6 installation
RUN curl https://bootstrap.pypa.io/get-pip.py | python3.6

# Setup Global git config
RUN git config --global user.email "noreply@gigantum.io"; git config --global user.name "Gigantum AutoCommit"

# Copy requirements.txt files
COPY submodules/labmanager-common/requirements.txt /opt/labmanager-common_requirements.txt
COPY submodules/labmanager-service-labbook/requirements.txt /opt/labmanager-service-labbook_requirements.txt

# Install dependencies
RUN pip3.6 install -r /opt/labmanager-common_requirements.txt
RUN pip3.6 install -r /opt/labmanager-service-labbook_requirements.txt

# Setup lmcommon config file - should be written by automation before copy
COPY developer_resources/labmanager-config.yaml /etc/gigantum/labmanager.yaml

# Setup logging config file
COPY submodules/labmanager-common/lmcommon/logging/logging.json.default /etc/gigantum/logging.json

# Make working dir and code mount points
RUN mkdir -p /mnt/gigantum; mkdir /opt/node_build

# Setup Redis
RUN mkdir /opt/redis
COPY labmanager_resources/redis.conf /opt/redis/redis.conf

# Setup Supervisord to launch redis and rq
RUN mkdir -p /opt/log/supervisor; mkdir -p /opt/run;
COPY labmanager_resources/supervisord_base.conf /etc/supervisor/supervisord.conf
COPY developer_resources/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

COPY developer_resources/entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod u+x /usr/local/bin/entrypoint.sh

# Expose Ports
EXPOSE 10000
EXPOSE 10001


# Copy SSH keys (for integration into GitLab remote)
RUN mkdir -p /root/.ssh
COPY developer_resources/id_rsa /root/.ssh
COPY developer_resources/id_rsa.pub /root/.ssh
RUN echo "StrictHostKeyChecking no" > /root/.ssh/config
RUN echo "UserKnownHostsFile /dev/null" >> /root/.ssh/config
RUN chmod 400 /root/.ssh/config
RUN chmod 400 /root/.ssh/id_rsa
RUN chmod 0644 /root/.ssh/id_rsa.pub
RUN ssh -T git@repo.gigantum.io -p 9922

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["/bin/bash"]
